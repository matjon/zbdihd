<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Sprawozdanie</title>

<!-- Opracowane na podstawie http://docs.mathjax.org/en/latest/start.html -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
        tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                processEscapes: true
        },
        TeX: { equationNumbers: { autoNumber: "all" } }
});
</script>


<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</head>
<body>


<h1>Zaawansowane Bazy Danych i Hurtownie Danych - Projekt badawczy</h1>

<h2>Opracowanie programowego modułu sterowania dla komory temperaturowej.</h2>

<p>Autorzy (skład zespołu):</p>

<ul>
<li>Mateusz Jończyk</li>
<li>Dawid Nowak</li>
</ul>

<p>kier. Informatyka SSM, sem. 3, gr. BDIS </p>

<p><strong>Proszę poczekać na załadowanie się wzorów matematycznych. W dolnym lewym
rogu jest pasek postępu. Może to trwać nawet 20 sekund</strong></p>

<h2>Sekcja 0: Wprowadzenie</h2>

<p>W dzisiejszych czasach, duża liczba produkowanych urządzeń czy też innych wyrobów 
wymaga mniej lub bardziej szczegółowej kontroli jakości. Takie wymaganie może być 
narzucone np. przepisami prawa, zapisami kontraktów/przetargów albo polityką
firmy zakładającą produkcję towarów wysokiej jakości. W przypadku chociażby
urządzeń elektronicznych zazwyczaj podaje się w specyfikacji również warunki, w
których dane urządzenie będzie działać prawidłowo (np. zakres temperatur).
W celu sprawdzenia jakości danego towaru, należy przeprowadzić 
badania empiryczne, m.in. poprzez sprawdzenie czy urządzenie działa
prawidłowo w różnych warunkach pracy.
Do takich badań służą komory klimatyczne i
temperaturowe. </p>

<p><strong>Komora klimatyczna</strong> zapewnia kontrolę zarówno temperatury jak i wilgotności
powietrza, <strong>temperaturowa</strong> - tylko temperatury.</p>

<p>Sterowanie komorą temperaturową jest bardzo podobne do sterowania systemami
<strong>HVAC</strong> (ang. Heating,
Ventilation, Air Conditioning). HVAC jest pojęciem bardzo szerokim. Swoim
zasięgiem obejmuje ogół zagadnień związanych z ogrzewaniem, wentylacją i
klimatyzacją wszelkich pomieszczeń (nie tylko komór klimatycznych). Najogólniej
rzecz biorąc HVAC zajmuje się kwestiami dostarczania i odprowadzania ciepła (np.
przez pompy ciepła, instalacje solarne, rekuperatory). </p>

<p>Efektywne sterowanie komorą klimatyczną i ogólnie systemami HVAC
jest
zadaniem bardzo trudnym.
Podstawowymi sterownikami
stosowanymi powszechnie w kontrolerach HVAC są sterowniki <strong>PID</strong>. Nie nadają się
one jednak zbyt dobrze do sterowania tego typu systemami
("Raad Z. Homod, Khairul Salleh Mohamed Sahari, Haider A.F. Almurib, Farrukh
Hafiz Nagi, Gradient auto-tuned Takagi–Sugeno Fuzzy Forward control of a HVAC
system using predicted mean vote index, Energy and Buildings, Volume 49, June
2012, Pages 254-267, ISSN 0378-7788,
<a href="
http://dx.doi.org/10.1016/j.enbuild.2012.02.013">http://dx.doi.org/10.1016/j.enbuild.2012.02.013</a>).
Z tego względu trzeba szukać innych metod.</p>

<p><strong>Algorytm opisany w naszej pracy został wymyślony przez nas w bardzo dużej mierze 
niezależnie.
Nie analizowaliśmy jednak literatury przedmiotu, z tego powodu przedstawione
przez nas podejście nie jest pewnie zbyt nowatorskie.</strong></p>

<p>Niniejsze opracowanie przedstawia teoretyczne rozważania problemu sterowania
grzałką w komorze klimatycznej w celu uzyskania żądanego przebiegu temperatury
(dopasowania krzywej temperaturowej) podczas symulacji. Podejście to opiera się
na analizie danych historycznych oraz korektach w czasie rzeczywistym.</p>

<h2>Sekcja 1: Założenia</h2>

<p>Dla skupienia uwagi będziemy projektować pod komory temperaturowe
 serii AR, produkowane przez ESPEC Corporation.
Ich dokumentacja jest dostępna 
<a href="http://www.klimatest.eu/katalog/leaflets/espec/Komory_serii_AR_v2_0.pdf 
" title="Komory serii AR v2.0">tutaj</a>
i <a href="http://www.klimatest.eu/katalog/Komory%20klimatyczne/_p/Komory%20klimatyczne%20i%20temperaturowe%20AR
" title="Komory serii AR v2.0">tutaj</a>.</p>

<p>Można założyć (w sposób dosyć agresywny):</p>

<ul>
<li><p><strong>okres co jaki wykonuje się pętla kontrolna: $W = 5$ sekund</strong>,</p>

<p>Pętla kontrolna składa się z następujących operacji: </p>

<ul>
<li>pobranie danych, </li>
<li>przetwarzanie,</li>
<li>ustawienie wyjść. </li>
</ul>

<p><p>Odstęp czasu między kolejnymi iteracjami pętli nazywamy <strong>przedziałem
czasu</strong> albo <strong>jednostką czasu</strong>. Zakładamy, że w jednym przedziale czasu ustawienia 
urządzeń wpływających na
temperaturę w komorze (moc grzałki, wentylatora, itd) są stałe, a temperatura
zmienia się jedynie w ograniczonym zakresie. 
Przedziały czasu będziemy indeksować kolejnymi liczbami całkowitymi, poczynając od 0.</p></li>
<li><p>po wyłączeniu grzania temperatura w komorze <strong>stabilizuje się w czasie 
mniejszym niż 10 minut</strong> (czyli po K = 120 jednostkach czasu).
Po tym czasie przestajemy śledzić konsekwencje grzania w przeszłości,</p></li>
</ul>
Wartości podane powyżej są dosyć wyśrubowane, można je złagodzić tak aby zmniejszyć
wartość K.</p>

<p>Ponadto:</p>

<ul>
<li><p>dokumentacja dla komór temperaturowych serii AR (pierwszy link, strona 5) podaje, 
że "Odchyłka temperatury w przestrzeni" jest równa 3,0 K. Jest to wartość dosyć duża.
Z tego względu wydaje się zasadne dopasowywanie bezpośrednio temperatury mierzonej
przez termometr do temperatury zadanej przez charakterystykę czasową i pomijanie
opóźnień na termometrze (wynikających raczej nie z natury samego termometru, ale
z czasu potrzebnego na dotarcie ciepła z grzałki do termometru).  </p></li>
<li><p>porównanie charakterystyk różnych mierników temperatury można znaleźć 
<a href="http://cp.literature.agilent.com/litweb/pdf/5965-7822E.pdf">tutaj</a>.
Zakładamy termistor, który wg nas jest najlepszy do zastosowania w omawianym urządzeniu.
Posiada on przede wszystkim bardzo dużą szybkość działania oraz dużą dokładność.</p></li>
<li><p>pomijamy chłodzenie, żeby uprościć problem. W sumie to jednak 
dosyć dobrze pasuje do różnych systemów HVAC, które mogą działać bez 
klimatyzatora (np. w zimie).</p></li>
<li><p>zakładamy, że czas potrzebny na wykonanie jednej iteracji pętli kontrolnej
jest pomijalny, zatem na początku każdego przedziału czasu będziemy w stanie
pobrać temperaturę, wykonać obliczenia jak i ustawić moc grzałki.
Algorytm da się jednak w dosyć 
prosty sposób dostosować do sytuacji kiedy tak nie jest.</p></li>
</ul>

<p>W pracy będziemy się starali ograniczyć drgania typu: 
grzanie -> chłodzenie (bo zbyt mocno ogrzaliśmy) -> grzanie (bo zbyt mocno ochłodziliśmy)</p>

<h2>Sekcja 2: Analiza wpływu grzania na przebieg temperatury w komorze</h2>

<p>Na zmiany temperatury w komorze mogą wpływać procesy (np. grzania) 
zachodzące stosunkowo dawno temu (wcześniej niż $K \cdot W$).
W tej sekcji postaramy się uchwycić to zachowanie komory w sposób matematyczny.</p>

<p><strong>Rozważamy jednostkę czasu o numerze $k$.</strong></p>

<p><strong>Przyrost temperatury</strong> podczas tej jednostki można przybliżyć jako:</p>

<p>$${\Delta}T[k] = T[k+1] - T[k] \approx \sum_{j=0}^{k} ({\Delta}T[k] \:|\: P[j])
\label{s2dec1}$$</p>

<p>(Na razie pomijamy upływ ciepła przez ściany komory. Pomijamy również ew. ciepło
wytwarzane w urządzeniu znajdującym się w komorze.)</p>

<p>Gdzie:</p>

<ul>
<li>$T[k]$ - temperatura <em>na początku</em> k-tej jednostki czasu,</li>
<li>$({\Delta}T[k] \:|\: P[j])$ - przyrost temperatury w k-tej jednostce czasu dzięki grzaniu w 
            j-tej jednostce czasu. Oczywiście $k {\geq} j$ (grzanie nie może wpłynąć
            na zmianę temperatury przed jego rozpoczęciem).</li>
</ul>

<p>Jesteśmy w stanie bezpośrednio zmierzyć jedynie $T[k]$, chcielibyśmy jednak znać
$({\Delta}T[k] \:|\: P[j])$.</p>

<p>Musimy więc założyć:</p>

<p>$$({\Delta}T[k] \:|\: P[j]) = P[j] f(k-j)\label{s2fdef}$$</p>

<p>Przy czym:</p>

<ul>
<li>$ P[j] $ - moc grzałki w jednostce czasu o indeksie $j$,</li>
<li><p>$ f(x) $ - pewna funkcja dążąca do zera dla $x$ dążącego do nieskończoności:</p>

<p>$$lim_{k \to +\infty} ({\Delta}T[k] \:|\: P[j]) = 0$$</p>

<p>Posiada ona następujące własności:</p>

<ul>
<li>jest zdefiniowana wyłącznie dla wartości nieujemnych (grzanie nie może wpłynąć
        na zmianę temperatury przed jego rozpoczęciem),</li>
<li>jeśli na początku rozważanego przedziału czasu układ znajdował się w równowadze,
to wartość $f(0)$ jest równa stosunkowi przyrostu temperatury w rozważanym przedziale czasu
do mocy grzałki w tym przedziale,</li>
<li><p>po K = 120 przedziałach czasu od rozpoczęcia grzania, ciepło wydzielone przez grzałkę zostaje 
rozproszone w komorze i nie wpływa już na zmiany temperatury na termometrze.
Z tego względu można uznać że <em>* $f(x) \equiv 0$ dla $x > K$ *</em>:</p></li>
<li><p>czyli $f(x)$ może być niezerowe tylko dla $0 \leq x \leq K$,</p></li>
<li><p>istnieje co najwyżej K+1 niezerowych wartości funkcji $f(x)$:
0 oraz od 1 do K,</p></li>
<li><p>mamy zatem jeden okres czasu przeznaczony na grzanie, który nie wlicza się do
     czasu stabilizacji, oraz K okresów, przez które temperatura 
     się stabilizuje.</p></li>
</ul></li>
</ul>

<p>Po podstawieniu $\ref{s2fdef}$ do $\ref{s2dec1}$ otrzymujemy:</p>

<p>$${\Delta}T[k] = T[k+1] - T[k] ≈ \sum_{j=0}^{k} P[j] f(k-j)$$</p>

<p>Po przyjęciu że $f(x) \equiv 0$ dla $x {\geq} K + 1$ mamy:</p>

<p>$${\Delta}T[k] = T[k+1] - T[k] ≈ \sum_{j=k-K}^{k} P[j] f(k-j)$$</p>

<p>(wewnętrzna suma przechodzi przez K + 1 wartości)</p>

<p><br></p>

<p>Rozważymy teraz dla przykładu postać sumy dla niskich wartości $k$:</p>

<p>Dla $k=0$:</p>

<p>${\Delta}T[0] = T[1] - T[0] ≈ \sum_{j=0}^{0} ({\Delta}T[0] \:|\: P[j]) = ({\Delta}T[0] \:|\: P[0])$</p>

<p>${\Delta}T[0] = T[1] - T[0] ≈ P[0] f(0)$</p>

<p>Dla $k=1$:</p>

<p>${\Delta}T[1] = T[2] - T[1] ≈ \sum_{j=0}^{1} ({\Delta}T[1] \:|\: P[j])$</p>

<p>${\Delta}T[1] = T[2] - T[1] ≈ ({\Delta}T[1] \:|\: P[0]) + ({\Delta}T[1] \:|\: P[1])$</p>

<p>${\Delta}T[1] = T[2] - T[1] ≈ ( P[0] f(1) + P[1] f(0) )$</p>

<p>I podsumowując, poprzez analogię:</p>

<p>$   {\Delta}T[0] = T[1] - T[0] ≈ (P[0] f(0))$</p>

<p>$   {\Delta}T[1] = T[2] - T[1] ≈ (P[0] f(1) + P[1] f(0))$</p>

<p>$   {\Delta}T[2] = T[3] - T[2] ≈ (P[0] f(2) + P[1] f(1) + P[2] f(0))$</p>

<p>$   {\Delta}T[3] = T[4] - T[3] ≈ (P[0] f(3) + P[1] f(2) + P[2] f(1) + P[3] f(0))$</p>

<p>Taką strukturę nazywamy 
<a href="http://en.wikipedia.org/wiki/Convolution#Discrete_convolution" title="Wikipedia: Convolution"><strong>splotem (convolution)</strong></a>.</p>

<p>Mamy więc:</p>

<p>$$  {\Delta}T[3] = T[4] - T[3] ≈ (P \ast f)[3]$$</p>

<p>i ogólnie:</p>

<p>$$  {\Delta}T[k] = T[k+1] - T[k] ≈ (P \ast f)[k]$$</p>

<p>W tym wypadku przy definicji splotu pomijamy składniki dla których $f(x) \equiv 0$.</p>

<p><br></p>

<p>Ostatecznie mamy układ równań o postaci:</p>

<p>$${\Delta}T[k] = T[k+1] - T[k] ≈ \sum_{j=k-K}^{k} P[j] f(k-j) = 
\sum_{j=0}^{K} P[k-j] f(j) = (P \ast f)[k] \label{s2eqs}$$</p>

<p>Ten układ równań posiada $K+1$ niewiadomych - tyle ile niezerowych wartości funkcji $f()$.</p>

<p>Dla każdej danej historycznej (pary wartości $P[j]$, $T[j]$) 
mamy zazwyczaj jedno równanie.
Jeżeli jednak system przy rozpoczęciu zbierania danych nie znajdował sie w stanie
równowagi termodynamicznej, musimy odrzucić pierwsze K pomiarów.
Odrzucamy też ostatnie K pomiarów.</p>

<h2>Sekcja 3: Uwzględnienie upływu ciepła</h2>

<p>Model komory grzewczej przestawiony w poprzedniej sekcji nie uwzględnia upływu 
ciepła przez jej ścianki. </p>

<p>Można założyć w dużym uproszczeniu, że <strong>szybkość upływu ciepła zależy wyłącznie 
od temperatury panującej w komorze</strong>. Uwzględnienie innych czynników (np. historii 
zmian temperatury) spowodowałoby znaczny wzrost liczby niewiadomych w układzie 
równań, co byłoby niekorzystne z dwóch względów:</p>

<ul>
<li>do wyliczenia układu równań potrzebnych byłoby bardzo wiele danych historycznych,</li>
<li>spadłaby znacznie dokładność oszacowania wartości niewiadomych.</li>
</ul>

<p>Niech $({\Delta}T[k] \:|\: T[k])$ - szybkość upływu ciepła z komory (zmiana temperatury zależna od 
obecnej temperatury w komorze).
Przyjmujemy, że $({\Delta}T[k] \:|\: T[k]) &lt; 0$.</p>

<p>Równanie $\ref{s2dec1}$ uzupełnione o wpływ temperatury przyjmuje postać: </p>

<p>$${\Delta}T[k] = T[k+1] - T[k] ≈ ({\Delta}T[k] \:|\: T[k]) + \sum_{j=0}^{k} ({\Delta}T[k] \:|\: P[j]) \label{s3eqs}$$</p>

<p>Żeby ograniczyć liczbę niewiadomych w układzie równań, można określić
$({\Delta}T[k] \:|\: T[k])$ co - powiedzmy - $L = 5\mathrm{°C}$ i wykonywać interpolację albo aproksymację 
dla pozostałych wartości
(trzeba tu zauważyć, że temperaturę będziemy znali z dokładnością co najmniej
0,1°C, zatem interpolacja lub aproksymacja i tak jest konieczna).</p>

<p>Szybkość ucieczki ciepła można aproksymować w podany poniżej prosty sposób:</p>

<ul>
<li>definiujemy pewną funkcję $j(x)$ - określoną dla wartości x podzielnych przez 5,</li>
<li>dla $k$ nie należącego do dziedziny funkcji $j(x)$ mamy (zaokrąglamy $k$ w dół do liczby podzielnej przez 5):</li>
</ul>

<p>$$m = T[k] - (k \bmod 5)$$</p>

<p>$$({\Delta}T[k] \:|\: T[k]) = \frac{j(m-5) + j(m) + j(m+5) + j(m+10)}{4}$$</p>

<ul>
<li>dla $k$ należącego do dziedziny funkcji $j(x)$ mamy:</li>
</ul>

<p>$$ ({\Delta}T[k] \:|\: T[k]) = \frac{j(T[k]-5) + j(T[k]) + j(T[k]+5)}{3}$$</p>

<p>Oznaczmy jako $w(t)$ szybkość upływu ciepła wyliczoną za pomocą powyższych równań.</p>

<p><br></p>

<p>Powyższe wzory można w prosty sposób uwzględnić w układzie równań $\ref{s2eqs}$:</p>

<p>$${\Delta}T[k] = T[k+1] - T[k] ≈ w(T[k]) + \sum_{j=k-K}^{k} P[j] f(k-j) =
         w(T[k]) + \sum_{j=0}^{K} P[k-j] f(j) = w(T[k]) + (P \ast f)[k] \label{s3eqs2}$$</p>

<p>Po rozwiązaniu go, otrzymujemy wartości funkcji $f(x)$ oraz $j(x)$, które będą potrzebne
do świadomego sterowania komorą.</p>

<h2>Sekcja 4: Sterowanie</h2>

<p>Znając wartości funkcji $f(x)$ oraz $j(x)$ wyliczone na podstawie danych historycznych,
można przewidzieć przebieg temperatury towarzyszący procesom grzania i z tego
względu w sposób świadomy sterować grzałką poprzez wybór optymalnego
przebiegu.</p>

<p>Przy wyliczaniu wartości funkcji $f(x)$ oraz $j(x)$ jest zalecane ograniczenie się 
do wartości $T[k]$ oraz $P[k]$ dla $k$ występującego stosunkowo dawno, tak żeby 
nie występowały trudne do uchwycenia interakcje między tym co się teraz 
dzieje a tym co było w niedawnej historii i co wpływa bezpośrednio na obecne 
decyzje.</p>

<p>Jesteśmy w chwili czasu $i$, mamy historię oraz przyszłość do decyzji.
(zmienne są dobrane tak żeby intuicyjnie $i \leq j \leq k$)</p>

<p>Oznaczenia:</p>

<ul>
<li>$i$ - obecna chwila czasu, którą analizujemy,</li>
<li>$j$ - indeksuje czas w którym przewidujemy że będziemy grzać,</li>
<li>$k$ - indeksuje temperaturę w przyszłości,</li>
</ul>

<p>Przyjmujemy uproszczony model ogrzewania przedstawiony w sekcji 3 - wzór $\ref{s3eqs2}$</p>

<p>$${\Delta}T[k] = T[k+1] - T[k] ≈ w(T[k]) + \sum_{j=0}^{K} P[k-j] f(j) = w(T[k]) + (P \ast f)[k] \label{s4eqs}$$</p>

<p>Będziemy postępowali podobnie jak doświadczony szachista, przewidujący
kilka ruchów naprzód a jednocześnie w każdym ruchu dostosowujący się do
działań rywala i aktualizujący odpowiednio swoją strategię.
Z drugiej strony będziemy postępowali podobnie jak przy sterowaniu rakietą.
Rakiety nie naprowadza się bowiem na
konkretną trasę, po prostu w każdej jednostce czasu 
wylicza się na podstawie obecnego położenia oraz innych czynników
nową trasę, która trochę się różni od starej i po niej rakietę prowadzi.</p>

<p>Niech $U[k]$ = żądana temperatura na początku przedziału czasowego $j$.
Na podstawie wartości $U[k]$ potrafimy policzyć 
$${\Delta}U[k] = U[k+1] - U[k]$$</p>

<p>Moglibyśmy tutaj ułożyć układ równań:
$${\Delta}U[k] = w(T[k]) + \sum_{j=0}^{K} P[k-j] f(j) $$
a następnie rozwiązać go, uzyskując potrzebne wartości $P[k-j]$.
Posługiwanie się szybkością zmiany temperatury jest jednak kiepskim pomysłem, a to ze 
względu na jeden prosty problem: zastana 
temperatura w komorze klimatycznej może odbiegać
znacząco od $U[k]$ i w tym wypadku dążenie do ${\Delta}T[k] = {\Delta}U[k]$ traci
sens. Nie pomoże też korekta pierwszej wartości $\Delta U[k]$, ponieważ zagubi się ona
w układzie równań i nie wpłynie znacząco na wynik.</p>

<p>Niestety, dopasowywanie $T[k] = U[k]$ znacząco komplikuje równania.</p>

<p>Mamy zatem:
$$T[k] = T[i] + \sum_{l=i}^{k-1} T[l+1] - T[l] = T[i] + \sum_{l=i}^{k-1} \Delta T[l] \nonumber$$</p>

<p>Podstawiamy do powyższego równania równanie  $\ref{s3eqs2}$, zamieniając $k \to l$:</p>

<p>$$T[k] = T[i] + \sum_{l=i}^{k-1} \left[ w(T[l]) + \sum_{j=l-K}^{l} P[j] f(l-j) \right]$$
$$T[k] = T[i] + \sum_{l=i}^{k-1} w(T[l]) + \sum_{l=i}^{k-1} \sum_{j=l-K}^{l} P[j] f(l-j)$$</p>

<p>Potrzebujemy teraz odwrócić kolejność sum w ostatnim składniku
powyższego równania, tak aby łatwo przejść do postaci macierzowej. 
Widzimy, że przy rozwinięciu sumy mamy wyrazy na $P$ od $P[i-K]$ do $P[k-1]$.
$P[j]$ występuje w składnikach sumy wyższego poziomu (indeksowanej przez $l$) dla 
$$l-K \leq j \leq l \label{s4sumsinvertion}$$
Każde $P[j]$ "widzi" więc takie wartości $l$. Trzeba jednak pamiętać że
wartości $l$ są dodatkowo ograniczone przez granice sumy zewnętrznej:</p>

<p>$$ i \leq l \leq k-1 \label{s4sumsinvertion2}$$</p>

<p>$P[j]$ jest więc mnożone przez
$\sum f(l-j)$ przy sumowaniu przez wszystkie wartości $l$ spełniające równania 
$\ref{s4sumsinvertion}$ oraz $\ref{s4sumsinvertion2}$. 
Po przekształceniach mamy więc następujące ograniczenia na $f(l-j)$:</p>

<p>$$
\begin {cases}
j \leq l \leq j+K       \\
i \leq l \leq k-1 
\end {cases}
$$</p>

<p>Oraz:
$$
\begin {cases}
0 \leq l-j \leq K       \\
i-j \leq l-j \leq k-j-1 
\end {cases}
$$
Pierwsze z tych równań jest ograniczeniem do niezerowej dziedziny funkcji $f(x)$.
W drugim równaniu pierwsza nierówność usuwa wyrazy $f(x)$ odnoszące 
się do zmian temperatury przed jednostką czasu $i$, druga nierówność - do 
zmian temperatury w jednostce czasu $k$ (przypominam że $T[k]$ = czas na początku
jednostki $k$) oraz po tej jednostce.</p>

<p>Ostatecznie mamy więc:
$$T[k] = T[i] + \sum_{l=i}^{k-1} w(T[l]) + 
        \sum_{j=i-K}^{k-1} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right] \label{s4equinverted}$$</p>

<hr>

<p>W celu zapewnienia optymalnego sterowania, będziemy starali się dążyć do $T[k] = U[k]$.
Da się to uzyskać rozwiązując układ równań, uzyskany
po podstawieniu tego wyrażenia do równania
$\ref{s4equinverted}$:</p>

<p>$$U[k] = T[i] + \sum_{l=i}^{k-1} w(T[l]) + 
        \sum_{j=i-K}^{k-1} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right] \label{s4equToSolve}$$</p>

<p>W tym układzie równań niewiadomymi są wartości $P[j]$ dla $j \geq i$. 
Będziemy w nim uwzględniać $R$ równań o postaci takiej jak powyżej,
pisanych dla kolejnych wartości U[k], poczynając od U[i+1].
Ograniczymy również liczbę niewiadomych do $Q$, przyjmując że dla wyższych
wartości $P[j] \equiv 0$.
Będziemy celowo rozwiązywać układ z mniejszą liczbą niewiadomych 
niż równań, ponieważ m.in. jest to konieczne w celu stosowania 
wag - zobacz niżej.</p>

<p>Dla $K=120$ sensowne wartości powyżej zdefiniowanych
parametrów to: $Q=80$ oraz $R=120$.</p>

<hr>

<p>Po wprowadzeniu tych ograniczeń wiersz układu równań przyjmuje postać:
$$U[k] = T[i] + \sum_{l=i}^{k-1} w(T[l]) + 
        \sum_{j=i-K}^{\min(k-1,\;Q)} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right] \label{s4equToSolve2}$$</p>

<p>Musimy teraz przekształcić ten układ równań do postaci macierzowej
(używam oznaczeń jak na <a href="http://en.wikipedia.org/wiki/Linear_least_squares_%28mathematics%29#The_general_problem">Wikipedii</a>):
$$\mathbf{y} = \mathbf{X} \mathbf{\beta} \label{s4equmartix}$$</p>

<p>Oznaczenia:</p>

<ul>
<li>$\mathbf{y}$ - wektor wyrazów wolnych,</li>
<li>$\mathbf{\beta}$ - wektor niewiadomych,</li>
<li>$\mathbf{X}$ - macierz współczynników. </li>
</ul>

<p>W tym celu zaczniemy od rozdzielenia wyrazów z $P[j]$ dla $j &lt; i$ (których wartości
znamy) oraz pozostałych (niewiadomych):
$$U[k] = T[i] + \sum_{l=i}^{k-1} w(T[l]) + 
        \sum_{j=i-K}^{i-1} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right]
        +
        \sum_{j=i}^{\min(k-1,\;Q)} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right]$$</p>

<p>Można optymistycznie założyć, że $T[l] \approx U[l]$ i przybliżyć
$w(T[l])$ przez $w(U[l])$.
(to założenie jest tym bardziej uzasadnione, że funkcja $w(x)$ rośnie stosunkowo
wolno)
Jednocześnie 
przenosimy wszystkie składniki o znanej wartości na lewą stronę:</p>

<p>$$U[k] - T[i] - 
        \sum_{l=i}^{k-1} w(U[l]) -
        \sum_{j=i-K}^{i-1} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right]
        =
        \sum_{j=i}^{\min(k-1,\;Q)} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right]$$</p>

<p>Element wektora wyrazów wolnych opisujący $U[k]$ ma więc postać
(przyjmujemy że macierze są indeksowane od 1):</p>

<p>$$\mathbf{y}[a] = 
        U[k] - T[i] - 
        \sum_{l=i}^{k-1} w(U[l]) -
        \sum_{j=i-K}^{i-1} \left[ 
        P[j] \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
        \right]
\qquad
        \textrm{przy czym } \quad k = i + a - 1
$$</p>

<p>Można tu zauważyć, że 
wektor $y$ odpowiada residualnej krzywej temperaturowej - poszczególne 
jego elementy zawierają informację o ile jeszcze musimy podnieść temperaturę w danym
przedziale czasowym.</p>

<p>Element wektora niewiadomych można zdefiniować jako:
$$\mathbf{\beta}[b] = P[j] <br>
\qquad
        \textrm{przy czym } \quad j = i + b - 1
$$</p>

<p>I wreszcie:
$$
\mathbf{X}[a,b] = 
        \sum_{l=\max(0,\; i-j)}^{\min(K,\; k-j-1)} f(l) 
\qquad
        \textrm{przy czym } \quad j = i + b - 1
        \quad \textrm{oraz } \quad k = i + a - 1
$$</p>

<p>We współrzędnych elementu wektora podajemy najpierw wiersz a później kolumnę.
Element $\mathbf{X}[a,b]$ jest mnożony z
$\mathbf{\beta}[b]$ a iloczyn ma być równy $\mathbf{y}[a]$.</p>

<p>Gdybyśmy macierze indeksowali od zera, wówczas $k = i+a$ oraz $j = i+b$.</p>

<p>Po skonstruowaniu w powyższy sposób macierzy $\mathbf{X}$ oraz wektora $\mathbf{y}$
oraz znalezieniu przybliżonego rozwiązania
układu równań 
$\ref{s4equmartix}$ (np. metodą najmniejszych kwadratów)
otrzymujemy wektor $\mathbf{\beta}$ i ostatecznie wartość $P[i]$.
Wyliczona wartość P[i] jest mocą grzałki którą należy ustawić w obecnej chwili
czasu tak aby zapewnić optymalne sterowanie.
Jeśli P[i] &lt; 0, grzanie w obecnej jednostce czasu wyłączamy.</p>

<p>Lepsze wyniki uzyskamy jednak, jeśli uwzględnimy wagi poszczególnych równań,
starając się dopasować </p>

<h2>Sekcja 5: Sterowanie - uwzględnianie wag</h2>

<p>Uwzględnienie wag przy rozwiązywaniu układu równań pozwala na łagodne odcięcie
wartości $U[k]$, dla których piszemy równania (zob. $\ref{s4equToSolve}$).</p>

<p>Najlepiej prawdopodobnie stopniowo zmniejszać wagę kolejnych pomiarów, tak
żeby waga dopasowania $T[k] = U[k]$ malała wraz z rosnącymi wartościami $k$.
W bardziej odległej przyszłości przewidywanie wartości temperatury
będzie trudniejsze, a układ będzie miał więcej czasu i możliwości reakcji.</p>

<p>Żeby przy rozwiązywaniu układu równań można było zastosować wagi,
musi posiadać on więcej równań niż niewiadomych, nadmiar powinien być odpowiednio
duży.</p>

<p>Pojawia się jednak problem, jak daleko w przód przewidujemy nasze ruchy.</p>

<p>Rozwiązywanie układu równań z uwzględnieniem wag błędów jest opisane na
<a href="http://math.stackexchange.com/a/709683">StackExchange</a>
oraz <a href="
http://en.wikipedia.org/wiki/Linear_least_squares_%28mathematics%29#Weighted_linear_least_squares">Wikipedii</a>.
Na obu tych stronach są stosowane różne oznaczenia.
Na StackExchange minimalizujemy $W(Ax−b)$, na Wikipedii: $W^{1/2}(X\beta - y)$
Tutaj konsekwentnie używamy oznaczeń z Wikipedii.</p>

<p>Błąd definiujemy jako różnicę $U[k] - T_{\textrm{wyliczone}}[k]$.</p>

<p>Będziemy potrzebowali macierz wag $\mathbf{W}$.
Jest to macierz diagonalna (z wartościami niezerowymi tylko na przekątnej).
Wektor błędu jest zdefiniowany jako:
$$\mathbf{e} = \mathbf{W}^{1/2}(\mathbf{X} \mathbf{\beta} - \mathbf{y})$$</p>

<p>Będziemy się starali minimalizować $e^{T} e$ - sumę kwadratów elementów wektora
błędu = sumę kwadratów błędów.</p>

<p>Znając macierz wag oraz macierze $\mathbf{X}$ i $\mathbf{y}$ wyliczamy
układ równań (normal equations):
$$\mathbf{X}^{T} \mathbf{W} \mathbf{X} \mathbf{\beta} = 
        \mathbf{X}^{T} \mathbf{W} \mathbf{y}$$</p>

<p>Posiada on tyle samo równań co niewiadomych.
Po jego wyliczeniu (w sposób dokładny) uzyskujemy wektor $\mathbf{\beta}$ 
minimalizujący $e^{T} e$.</p>

<p>Wikipedia zaleca żeby wagi były odwrotnością wariancji pomiarów.</p>

<p>Niech $z(k-i)$ - waga dla dopasowania wartości $U[k]$ 
($i$ - indeks przedziału czasu w którym wykonywany jest algorytm).
Wymagania dla funkcji generującej wagi:
   - ma dążyć stosunkowo szybko do zera, 
     powiedzmy dla argumentów > 80 (przy $K = 120$) jej wartości 
     mają już być pomijalne,
   - nie może zbyt mocno maleć dla niewielkich argumentów (powiedzmy, &lt; 40),</p>

<p>Po wykonywaniu eksperymentów w LibreOffice, stwierdziłem że 
dla 
$K = 120$, funkcja o postaci
$$z(x) = w[u] = (u+10)^{-1.2}$$
daje wystarczająco dobre rezultaty. </p>

<h2>Sekcja 6 - suplement</h2>

<p>Niedokończone i niedopracowane pomysły</p>

<h3>Rozpisanie funkji $f(x)$</h3>

<p>Można by rozpisać funkcję $f(x)$ na następujące składniki:</p>

<p>$$f(x) = g(x) e^{-\frac{t}{T}} c_1$$</p>

<p>Przy czym:</p>

<ul>
<li>$ g(x) &lt; 1 $,</li>
<li>$ g(0) = 1 $ (tak żeby $c_{1}$ ustalić na sztywno)
            //jednak to by nie było dopuszczalne, ponieważ f(0) może być
            //stosunkowo małe, mniejsze niż g(1)</li>
<li>$T$ - jakaś liczba.</li>
</ul>

<p>Mogłoby to ew. pomóc przy rozwiązywaniu układu równań - można w ten sposób ograniczyć
wartości funkcji $ f(x) $.</p>

<p>Może być jednak problem z uwzględnieniem $g(x) &lt; 1$ przy rozwiązywaniu tego 
układu równań (wymagałoby to użycia innych metod rozwiązywania układu równań niż 
powszechnie stosowane).</p>

<h3>Inne podejście do wykorzystywania historii</h3>

<p>Mamy dane N zbiorów danych historycznych o postaci:</p>

<p>{kontekst, akcja, reakcja}</p>

<ul>
<li>akcja - jaką czynność podjęliśmy w danej chwili,</li>
<li>kontekst - co działo się z układem przed podjęciem akcji,</li>
<li>reakcja - jakie były skutki podjętej akcji.</li>
</ul>

<p>Zakładając że znamy wartości funkcji f (wyliczone z powyższego układu równań), 
możemy skonstruować rekordy danych historycznych:</p>

<p>Podobnie jak poprzednio, rozważamy k-ty rekord danych historycznych, dotyczący 
grzania w k-tym przedziale czasu,</p>

<ul>
<li><p>kontekst:</p>

<ul>
<li>$\sum_{j=k-119}^{k} \frac{\Delta T[j]}{t}$</li>
<li>$\sum_{j=k-119}^{k} \frac{\Delta T[j]}{t^{2}}$</li>
<li>$\sum_{j=k-120}^{k} \frac{P[j]}{t}$</li>
<li>$\sum_{j=k-120}^{k} \frac{P[j]}{t^{2}}$</li>
<li>ewentualnie $T[k]$</li>
</ul></li>
<li><p>akcja:</p>

<ul>
<li>$P[k]$</li>
</ul></li>
<li><p>reakcja:</p>

<ul>
<li><p>Zdefiniujmy $(ΔT[k-1] || P[j])$ - przyrost temperatury który da się 
przypisać grzaniu w k-tej jednostce czasu,</p></li>
<li><p>rekord zawierałby całki takie same jak dla kontekstu, z tym że 
dla $(ΔT[k-1] || P[j])$ i oczywiście indeksy wartości byłyby większe od k, 
znaczy się sumowane wszystko byłoby w przód,</p></li>
<li><p>albo może po prostu surowe przebiegi $(ΔT[k-1] || P[j]) $</p></li>
</ul></li>
</ul>

<p>Mając N <em>pełnych</em> rekordów historycznych (znaczy się takich które 
zostały sporządzone więcej niż 120 okresów temu, tak że reakcje są w pełni 
wyliczone).</p>

<h3>Inne</h3>

<ul>
<li><p>Plik <a href="https://github.com/matjon/zbdihd/blob/master/TODO.txt">TODO.txt</a></p></li>
<li><p>Kod źródłowy tego pliku - do edycji: 
<a href="https://github.com/matjon/zbdihd">Github</a></p></li>
</ul>

<!--      vim: set spelllang=pl filetype=markdown :    -->
</body>
</html>
